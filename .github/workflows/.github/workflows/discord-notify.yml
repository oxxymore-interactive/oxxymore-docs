name: GitHub -> Discord (Activity)

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  notify:
    name: Notify Discord
    runs-on: ubuntu-latest

    # PR: uniquement si la PR vise main
    if: |
      github.event_name != 'pull_request' || github.base_ref == 'main'

    steps:
      - name: Build Discord message
        id: build
        shell: bash
        run: |
          set -euo pipefail

          REPO="${GITHUB_REPOSITORY##*/}"

          # Prefix repo -> [DOCS]/[CORE]/[WEB]
          case "$REPO" in
            *docs*) PREFIX="[DOCS]" ;;
            *web*)  PREFIX="[WEB]"  ;;
            *)      PREFIX="[CORE]" ;;
          esac

          # Emoji selon event
          case "${GITHUB_EVENT_NAME}" in
            issues)       EMOJI="üêõ" ;;
            push)         EMOJI="üöÄ" ;;
            pull_request) EMOJI="üîÄ" ;;
            *)            EMOJI="üîî" ;;
          esac

          # Message selon event
          if [ "${GITHUB_EVENT_NAME}" = "issues" ]; then
            TITLE='${{ github.event.issue.title }}'
            URL='${{ github.event.issue.html_url }}'
            ACTOR='${{ github.actor }}'
            NUMBER='${{ github.event.issue.number }}'
            CONTENT="$EMOJI $PREFIX Issue #$NUMBER opened by $ACTOR: $TITLE ‚Äî $URL"

          elif [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            TITLE='${{ github.event.pull_request.title }}'
            URL='${{ github.event.pull_request.html_url }}'
            ACTOR='${{ github.actor }}'
            NUMBER='${{ github.event.pull_request.number }}'
            BASE='${{ github.base_ref }}'
            CONTENT="$EMOJI $PREFIX PR #$NUMBER opened (base: $BASE) by $ACTOR: $TITLE ‚Äî $URL"

          elif [ "${GITHUB_EVENT_NAME}" = "push" ]; then
            ACTOR='${{ github.actor }}'
            REF='${{ github.ref_name }}'
            URL="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
            CONTENT="$EMOJI $PREFIX Push on $REF by $ACTOR ‚Äî $URL"

          else
            CONTENT="$EMOJI $PREFIX Event: ${GITHUB_EVENT_NAME}"
          fi

          # Export pour √©tape suivante
          echo "content<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CONTENT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_GITHUB_ACTIVITY }}
        run: |
          set -euo pipefail
          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "Missing secret: DISCORD_WEBHOOK_GITHUB_ACTIVITY"
            exit 1
          fi

          curl -sS -X POST \
            -H "Content-Type: application/json" \
            -d "{\"content\":\"${{ steps.build.outputs.content }}\"}" \
            "$DISCORD_WEBHOOK_URL"
